<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar evento</title>

    <link rel="shortcut icon" href="assets/img/logo.xs.svg" type="image/x-icon">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="CSS/reset.css">
    <link rel="stylesheet" href="./CSS/components/navbar.css">
    <link rel="stylesheet" href="CSS/components/navbar-mobile.css">
    <link rel="stylesheet" href="CSS/components/popup.css">
    <link rel="stylesheet" href="./CSS/components/footer.css">
    <link rel="stylesheet" href="./CSS/components/title.css">
    <link rel="stylesheet" href="CSS/components/page-style.css">
    <link rel="stylesheet" href="./CSS/components/sobreNos.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="CSS/components/criar-evento.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC6Mt2GUjTup_ly3tWro_MnX6L9v_l5o1s&libraries=places&language=pt-BR"></script>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>

    <script src="https://cdn.tiny.cloud/1/td7wgm1izo9h3d17s951if482d4qpmpsfljff1630roi5k00/tinymce/7/tinymce.min.js"
        referrerpolicy="origin"></script>

    <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
  <script src="./JS/obterUrlBase.js"></script>



</head>

<body>
    <header>
        <div class="navcenter" id="navbar-logged-out">
            <div>
                <a href="index.html">
                    <img class="logo" src="assets/img/logo2.svg" alt="logo do NaFaixa" />
                </a>
            </div>
            <nav class="nav-options-web">
                <div onclick="openPopup()" class="localização-web">
                    <img src="assets/img/localpin.svg" </img>
                    <span class="localização-web" id="escolherLocalização">Localização</span>
                    <img src="assets/img/setaprabaixo1.svg" style="padding-right: 15px"></img>
                </div>

                <a onclick='return handleCriarEventoOnClick()' href="criar-evento.html">Criar evento</a>
                <a id="entrar-btn" class="joinBtn" href="login.html">Entrar</a>
            </nav>

        </div>

        <div class="navcenter-mobile" id="navbar-logged-in" style="display: none">
            <div>
                <a href="index.html">
                    <img class="logo" src="assets/img/logo2.svg" alt="logo do NaFaixa" />
                </a>
            </div>
            <nav class="nav-options-web">
                <div class="nav-options-logged-in">
                    <div onclick="openPopup()" class="localização-web">
                        <img src="assets/img/localpin.svg" </img>
                        <span class="localização-web" id="escolherLocalizaçãoLoggedin">Localização</span>
                        <img src="assets/img/setaprabaixo1.svg" style="padding-right: 15px"></img>
                    </div>
                    <a id="hide-criar-evento-mobile" href="criar-evento.html">Criar evento</a>

                    <nav class="menu-hamburguer">
                        <input type="checkbox" class="checkbox-menu">

                        <img id="logo-produtor-menu" src="https://source.unsplash.com/random/1" alt="foto perfil">

                        <div id="menu-options2">
                            <ul>
                                <a id="meu-perfil" href="cadastro-produtor.html" onclick="redirecionarParaEdicao()">Meu
                                    Perfil</a></br>
                                <a href="meus-eventos.html">Meus eventos</a></br>
                                <a href="criar-evento.html">Criar evento</a>
                                <a id="botaoSair" href="#">Sair</a>
                            </ul>
                        </div>
                    </nav>
                </div>
            </nav>
        </div>
        </div>

        <div class="navcenter-mobile" id="navbar-logged-out-mobile">
            <div>
                <a href="index.html">
                    <img class="logo" src="assets/img/logo2.svg" alt="logo do NaFaixa" /></a>
            </div>
            <div onclick="openPopup()" class="localizacao-mobile">
                <img src="assets/img/localpin.svg" </img>
                <span class="localizacao-mobile" id="escolherLocalizacaoMobile">Localização</span>
            </div>
            <nav class="menu-hamburguer">
                <input type="checkbox" class="checkbox-menu">

                <label for="checkbox-menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </label>

                <div id="menu-options">
                    <ul>
                        <a href="login.html">Entrar</a></br>
                        <a onclick='return handleCriarEventoOnClick()' href="criar-evento.html">Criar evento</a>
                        <a id="botaoSair" href="#">Sair</a>
                    </ul>
                </div>
            </nav>
        </div>
        </nav>
        </div>
    </header>

    <form action="todos-eventos.html" method="GET" id="search-form" class="nav-search-mobile">
        <div class="search">
            <span class="search-icon material-symbols-outlined">search</span>
            <input type="text" class="search-input" name="q" placeholder="Pesquise por evento...">
        </div>
    </form>

    <div class="popup" id="locationPopup">
        <div class="popup-content">
            <h5>Escolha uma localização</h5>
            <input type="text" id="cityInput" placeholder="Digite o nome da cidade que deseja...">
        </div>
    </div>


    <section class="page">
        <div style="width: 100%">
            <section>
                <h1>Informações do evento</h1>

                <form class="new-event-form">
                    <div class="header-form">
                        <div>
                            <input type="radio" id="evento-presencial-radio" name="event-type" value="presencial"
                                checked>
                            <label for="evento-presencial-radio">Evento presencial</label>
                        </div>

                        <div>
                            <input type="radio" id="evento-online-radio" name="event-type" value="online">
                            <label for="evento-online-radio">Evento online</label>
                        </div>

                        <select id="categorias" name="categorias" required>
                            <option value="">Categorias</option>

                        </select>
                    </div>

                    <div class="form-item">
                        <label for="nome">Nome</label>
                        <input type="text" id="nome" name="nome" required>
                    </div>

                    <div id="evento-presencial-form">

                        <div class="form-item">
                            <label for="local">Local</label>
                            <input type="text" id="local" placeholder="Digite o local do evento" autocomplete="off"
                                required>
                        </div>
                    </div>

                    <div id="evento-online-form">
                        <div class="form-item">
                            <label for="link-evento-online">Informe o link do evento online.</label>
                            <input type="text" name="evento-online" id="link-evento-online" required>
                        </div>
                    </div>

                    <div class="form-item-pair">
                        <div class="form-item-shrinked">
                            <label for="start-date">Data início do evento</label>
                            <input type="text" id="start-date" placeholder="Selecione a data" required>
                        </div>
                        <div class="form-item-shrinked">
                            <label for="start-time">Horário do início do evento</label>
                            <input type="text" id="start-time" placeholder="Selecione a hora" required>
                        </div>
                    </div>

                    <div class="form-item-pair">
                        <div class="form-item-shrinked">
                            <label for="final-date">Data final do evento</label>
                            <input type="text" id="final-date" placeholder="Selecione a data">
                        </div>
                        <div class="form-item-shrinked">
                            <label for="final-time">Horário final do evento</label>
                            <input type="text" id="final-time" placeholder="Selecione a hora">
                        </div>
                    </div>

                    <section>
                        <h1>Sobre o evento</h1>

                        <div class="form-item">
                            <label for="sobre">Fale sobre o evento.</label>
                            <textarea id="sobre" name="sobre o evento" required></textarea>
                        </div>

                    </section>

                    <section>
                        <h1>Informações gerais</h1>

                        <div class="form-item">
                            <label for="informacoes">Forneça informações gerais sobre o evento - tais como faixa etária,
                                etc.</label>
                            <textarea rows="15" type="text" name="informacoes do evento" id="informacoes"
                                required></textarea>
                        </div>

                        <!--                        <div class="form-item">-->
                        <div>
                            <label>Faça upload do banner do evento</label><br>
                            <button id="event-banner-input" class="cloudinary-button">
                                Upload files
                            </button>



                        </div>
                        <img id="uploadedimage" src=""></img>
                        <!--                        </div>-->


                        <div class="termos-uso">
                            <input id="terms-checkbox" type="checkbox">
                            <label>Li e aceito os <a href="termosdeuso.html" target="_blank">termos de uso.</a></label>
                        </div>
                    </section>
                </form>
            </section>
        </div>
    </section>

    <div class="rounded-button">
        <button type="submit" class="criar-evento-btn">Criar evento</button>
    </div>

    <footer>

        <div class="footercenter">
            <div class="subtitulo">
                <p>O seu site de eventos gratuitos</p>
                <img class="logofooter" src="assets/img/logo2.svg" alt="logo NaFaixa">
            </div>

            <div class="txtfooter">
                <a href="sobrenos.html">Sobre nós</a>
                <a href="termosdeuso.html">Termos de uso</a>
            </div>
        </div>
    </footer>

    <!-- ----------------------------------------------------------------------------------------------- -->

    <script src="JS/navbarUpdate.js"></script>

    <script src="JS/barra-pesquisa.js"></script>

    <script src="JS/logout.js"></script>

    <script src="JS/meusEventos.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC6Mt2GUjTup_ly3tWro_MnX6L9v_l5o1s&libraries=places"></script>
    <script>

        function handleCriarEventoOnClick(e) {
            if (!isUserLoggedIn()) {
                window.location.href = 'login.html';
                return false;
            };
        };

        function isUserLoggedIn() {
            return localStorage.getItem('userData');
        };

        // Função para obter a geolocalização do usuário
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;

                        const geocoder = new google.maps.Geocoder();
                        const latlng = { lat: latitude, lng: longitude };

                        geocoder.geocode({ location: latlng }, (results, status) => {
                            if (status === "OK") {
                                if (results[0]) {
                                    const cityName = results[0].address_components[3].long_name;

                                    localStorage.setItem('userLocation', JSON.stringify({
                                        latitude: latitude,
                                        longitude: longitude,
                                        city: cityName
                                    }));

                                    updateNavbarLocation(cityName);
                                }
                            }
                        });
                    },
                    (error) => {
                        console.error('Erro ao obter localização:', error);
                    }
                );
            } else {
                console.error('Geolocalização não suportada pelo navegador.');
            }
        }

        // Função para abrir o popup/fechar o popup
        const popup = document.getElementById('locationPopup');

        function openPopup() {
            popup.style.display = 'block';

            window.addEventListener('click', closePopupOutside);

            window.addEventListener('keydown', closePopupOnEsc);

            function closePopupOutside(event) {
                if (event.target === popup) {
                    popup.style.display = 'none';
                    window.removeEventListener('click', closePopupOutside);
                    window.removeEventListener('keydown', closePopupOnEsc);
                }
            }

            function closePopupOnEsc(event) {
                if (event.key === 'Escape') {
                    popup.style.display = 'none';
                    window.removeEventListener('click', closePopupOutside);
                    window.removeEventListener('keydown', closePopupOnEsc);
                }
            }

            //Função de autocomplete do google no input do popup
            var input = document.getElementById('cityInput');
            var autocomplete = new google.maps.places.Autocomplete(input, {
                types: ['(cities)'],
                componentRestrictions: { country: 'BR' }
            });

            autocomplete.addListener('place_changed', function () {
                var selectedPlace = autocomplete.getPlace();
                if (!selectedPlace.geometry) {
                    return;
                }

                var cityName = selectedPlace.name;

                updateNavbarLocation(cityName);

                localStorage.setItem('userLocation', JSON.stringify({
                    cityName: cityName,
                    latitude: selectedPlace.geometry.location.lat(),
                    longitude: selectedPlace.geometry.location.lng()
                }));
                window.location.href = window.location.href;

                document.getElementById('locationPopup').style.display = 'none';
            });
        }

        // Função para atualizar a localização na navbar
        function updateNavbarLocation(cityName) {
            var locationElementWeb = document.getElementById('escolherLocalização');
            var locationElementMobile = document.getElementById('escolherLocalizacaoMobile');
            var locationElementLoggedIn = document.getElementById('escolherLocalizaçãoLoggedin');
            if (locationElementWeb) {
                locationElementWeb.textContent = cityName;
            }
            if (locationElementMobile) {
                locationElementMobile.textContent = cityName;
            }
            if (locationElementLoggedIn) {
                locationElementLoggedIn.textContent = cityName;
            }
        }

        window.onload = function () {
            var userLocation = localStorage.getItem('userLocation');
            if (userLocation) {
                userLocation = JSON.parse(userLocation);
                if (userLocation.cityName) {
                    updateNavbarLocation(userLocation.cityName);
                }
            }
        };

        // Função para atualizar o nome da cidade na navbar
        function updateNavbarLocation(cityName) {
            var locationElementWeb = document.getElementById('escolherLocalização');
            var locationElementMobile = document.getElementById('escolherLocalizacaoMobile');
            var locationElementLoggedIn = document.getElementById('escolherLocalizaçãoLoggedin');
            if (locationElementWeb) {
                locationElementWeb.textContent = cityName;
            }
            if (locationElementMobile) {
                locationElementMobile.textContent = cityName;
            }
            if (locationElementLoggedIn) {
                locationElementLoggedIn.textContent = cityName;
            }
        }

        window.onload = () => {
            const userLocation = JSON.parse(localStorage.getItem('userLocation'));
            if (!userLocation) {
                getLocation();
            } else {
                updateNavbarLocation(userLocation.city);
            }
        };

        // Função para carregar e definir a localização ao recarregar a página
        function loadUserLocation() {
            var userLocation = localStorage.getItem('userLocation');
            if (userLocation) {
                userLocation = JSON.parse(userLocation);
                if (userLocation.cityName) {
                    updateNavbarLocation(userLocation.cityName);
                }
            }
        }

        window.addEventListener('load', function () {
            loadUserLocation();
        });

    </script>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC6Mt2GUjTup_ly3tWro_MnX6L9v_l5o1s&libraries=places&language=pt-BR"></script>
    </script>

    <!-- Formata a data e hora  -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>

        flatpickr("#start-date", {
            dateFormat: "d/m/Y",
            locale: "pt",
        });

        flatpickr("#start-time", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            time_24hr: true,
        });

        flatpickr("#final-date", {
            dateFormat: "d/m/Y",
            locale: "pt",
        });

        flatpickr("#final-time", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            time_24hr: true,
        });
        //------------------------------------------------------------------------------------------//

        document.getElementById("evento-presencial-radio").onclick = function () {
            document.getElementById("evento-presencial-form").style.display = "block";
            document.getElementById("evento-online-form").style.display = "none";
        }

        document.getElementById("evento-online-radio").onclick = function () {
            document.getElementById("evento-online-form").style.display = "block";
            document.getElementById("evento-presencial-form").style.display = "none";
        }

        const eventBannerInput = document.querySelector('#event-banner-input');
        const eventBannerPreview = document.querySelector('#event-banner-preview')

        eventBannerInput.onchange = evt => {
            const [file] = eventBannerInput.files
            if (file) {
                eventBannerPreview.src = URL.createObjectURL(file)
            }
            eventBannerPreview.style.display = "block"
        }
        //-----------------------------------------------------------------------------------------//

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(obterUrlBase()+'/categorias');
                const categorias = await response.json();

                popularCategorias(categorias);
            } catch (error) {
                console.error('Erro ao obter categorias:', error);
            }
        });

        function popularCategorias(categorias) {
            const selectCategorias = document.querySelector('#categorias');

            selectCategorias.innerHTML = '<option value="">Categoria</option>';

            categorias.forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria.nome;
                option.textContent = categoria.nome;
                selectCategorias.appendChild(option);
            });
        }
        //-----------------------------------------------------------------------------------------------------------------//
        tinymce.init({
            selector: '#sobre',
            height: 300
        });

        let selectedPlace = null;
        let bannerUrl = null;

        function initializeAutocomplete() {
            var input = document.getElementById('local');
            var options = {
                componentRestrictions: { country: 'BR' }
            };

            var autocomplete = new google.maps.places.Autocomplete(input, options);

            autocomplete.addListener('place_changed', function () {
                selectedPlace = autocomplete.getPlace();
            });
        }

        const cloudName = "nafaixa";
        const uploadPreset = "nafaixa";

        const myWidget = cloudinary.createUploadWidget(
            {
                cloudName: cloudName,
                uploadPreset: uploadPreset
            },
            (error, result) => {
                if (!error && result && result.event === "success") {
                    console.log("Upload concluído! Aqui estão as informações da imagem: ", result.info);
                    alert('Upload de imagem concluído!');
                    document.getElementById("uploadedimage").setAttribute("src", result.info.secure_url);
                    bannerUrl = result.info.secure_url;
                    bannerUrl = result.info.secure_url;
                }
            }
        );

        document.getElementById("event-banner-input").addEventListener(
            "click",
            function () {
                myWidget.open();
            },
            false
        );

        async function criarEvento() {
            const termsCheckbox = document.getElementById('terms-checkbox');

            if (!termsCheckbox.checked) {
                alert('Você precisa aceitar os termos de uso antes de criar o evento.');
                return;
            }

            const nomeEvento = document.querySelector('#nome');
            const categorias = document.querySelector('#categorias');
            const tipoEvento = document.querySelector('input[name="event-type"]:checked');
            const startDateEvento = document.querySelector('#start-date');
            const startTimeEvento = document.querySelector('#start-time');
            const sobreEvento = document.querySelector('#sobre');
            const informacoesEvento = document.querySelector('#informacoes');
            const sobre = tinymce.get('sobre').getContent();

            if (!nomeEvento.value) {
                alert('O campo nome é obrigatório.');
                nomeEvento.focus();
                return;
            }
            if (!categorias.value) {
                alert('O campo categorias é obrigatório.');
                categorias.focus();
                return;
            }
            if (!tipoEvento) {
                alert('Selecione o tipo de evento (presencial ou online).');
                return;
            }
            if (!startDateEvento.value) {
                alert('O campo data de início do evento é obrigatório.');
                startDateEvento.focus();
                return;
            }
            if (!startTimeEvento.value) {
                alert('O campo horário de início do evento é obrigatório.');
                startTimeEvento.focus();
                return;
            }
            if (!sobre.trim()) {
                alert('O campo sobre o evento é obrigatório.');
                return;
            }
            if (!informacoesEvento.value) {
                alert('O campo informações adicionais é obrigatório.');
                informacoesEvento.focus();
                return;
            }

            const tipoEventoValue = tipoEvento.value;

            if (tipoEventoValue === 'presencial') {
                if (!selectedPlace || !selectedPlace.formatted_address) {
                    alert('O campo local é obrigatório para eventos presenciais.');
                    document.getElementById('local').focus();
                    return;
                }
            }

            if (tipoEventoValue === 'online') {
                const linkEventoOnline = document.querySelector('#link-evento-online');
                if (!linkEventoOnline.value) {
                    alert('O campo link do evento é obrigatório para eventos online.');
                    linkEventoOnline.focus();
                    return;
                }
            }

            try {
                const response = await fetch(obterUrlBase()+`/eventos?nome=${encodeURIComponent(nomeEvento.value)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (!response.ok) {
                    throw new Error('Erro ao verificar a existência do evento');
                }

                const data = await response.json();

                if (data && data.length > 0) {
                    const existingEvent = data[0];

                    const existingStartDate = new Date(existingEvent.startDate);
                    const selectedStartDate = new Date(startDateEvento.value);

                    if (existingEvent.local === (selectedPlace ? selectedPlace.formatted_address : '') &&
                        existingStartDate.getTime() === selectedStartDate.getTime()) {
                        alert('Já existe um evento com o mesmo nome, local e data de início. Por favor, crie um evento que ainda não exista em nosso site.');
                        return;
                    }
                }

                if (!bannerUrl) {
                    alert('É obrigatório fazer o upload de uma imagem para o banner do evento.');
                    return;
                }

                const idEvento = uuidv4();
                const categoriaValue = categorias.value;
                const link = tipoEventoValue === 'online' ? document.querySelector('#link-evento-online').value : '';
                const finalDateEvento = document.querySelector('#final-date').value;
                const finalTimeEvento = document.querySelector('#final-time').value;

                const produtorId = localStorage.getItem('userData');

                if (!produtorId) {
                    alert('Erro ao obter o ID do produtor. Faça login novamente.');
                    return;
                }

                const evento = {
                    id: idEvento,
                    produtorId: produtorId,
                    tipo: tipoEventoValue,
                    categoria: categoriaValue,
                    nome: nomeEvento.value,
                    link: link,
                    nomeLocal: selectedPlace ? selectedPlace.name : '',
                    local: selectedPlace ? selectedPlace.formatted_address : '',
                    latitude: selectedPlace ? selectedPlace.geometry.location.lat() : null,
                    longitude: selectedPlace ? selectedPlace.geometry.location.lng() : null,
                    startDate: startDateEvento.value,
                    startTime: startTimeEvento.value,
                    finalDate: finalDateEvento,
                    finalTime: finalTimeEvento,
                    sobre: sobre,
                    informacoes: informacoesEvento.value,
                    bannerURL: bannerUrl
                };

                const createResponse = await fetch(obterUrlBase()+'/eventos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(evento),
                });

                if (!createResponse.ok) {
                    throw new Error('Erro ao criar evento');
                }

                window.location.replace('meus-eventos.html');

                const responseData = await createResponse.json();
                console.log('Evento criado:', responseData);
                alert('Evento criado com sucesso!');


            } catch (error) {
                console.error('Erro ao criar evento:', error);
                alert('Erro ao criar evento. Tente novamente mais tarde.');
            }
        }

        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeAutocomplete();

            const startDateInput = document.querySelector('#start-date');
            const finalDateInput = document.querySelector('#final-date');

            const startDatePicker = flatpickr(startDateInput, {
                dateFormat: "d/m/Y",
                locale: "pt",
                minDate: "today",
                onClose: function (selectedDates) {
                    if (selectedDates.length > 0) {
                        const minDate = selectedDates[0];
                        finalDatePicker.set('minDate', minDate);
                    }
                }
            });

            const finalDatePicker = flatpickr(finalDateInput, {
                dateFormat: "d/m/Y",
                locale: "pt",
            });

            const criarEventoBtn = document.querySelector('.criar-evento-btn');
            criarEventoBtn.addEventListener('click', (event) => {
                event.preventDefault();

                const startDate = startDatePicker.selectedDates[0];
                const finalDate = finalDatePicker.selectedDates[0];

                if (startDate.getTime() > finalDate.getTime()) {
                    alert('A data final do evento deve ser posterior à data de início.');
                    return;
                }

                criarEvento();
            });
        });
        document.addEventListener('DOMContentLoaded', async () => {
            initializeAutocomplete();

            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('edit');

            if (eventId) {
                try {
                    const response = await fetch(obterUrlBase()+`/eventos/${eventId}`);
                    if (!response.ok) {
                        throw new Error('Erro ao carregar dados do evento');
                    }

                    const event = await response.json();
                    populateForm(event);

                    const criarEventoBtn = document.querySelector('.criar-evento-btn');
                    criarEventoBtn.textContent = 'Salvar alterações';
                    criarEventoBtn.addEventListener('click', (event) => {
                        event.preventDefault();
                        updateEvent(event, startDatePicker, finalDatePicker);
                    });
                } catch (error) {
                    console.error('Erro ao carregar evento:', error);
                }
            } else {
                const criarEventoBtn = document.querySelector('.criar-evento-btn');
                criarEventoBtn.addEventListener('click', criarEvento);
            }

            const startDateInput = document.querySelector('#start-date');
            const finalDateInput = document.querySelector('#final-date');

            const startDatePicker = flatpickr(startDateInput, {
                dateFormat: "d/m/Y",
                locale: "pt",
                minDate: "today",
                onClose: function (selectedDates) {
                    if (selectedDates.length > 0) {
                        const minDate = selectedDates[0];
                        finalDatePicker.set('minDate', minDate);
                    }
                }
            });

            const finalDatePicker = flatpickr(finalDateInput, {
                dateFormat: "d/m/Y",
                locale: "pt",
            });
        });

        function populateForm(event) {
            document.querySelector('#nome').value = event.nome;
            document.querySelector('#categorias').value = event.categoria;
            document.querySelector(`input[name="event-type"][value="${event.tipo}"]`).checked = true;
            document.querySelector(`input[name="event-type"][value="${event.tipo}"]`).checked = true;

            if (event.tipo === 'presencial') {
                document.querySelector('#local').value = event.local;
                selectedPlace = {
                    formatted_address: event.local,
                    geometry: {
                        location: {
                            lat: () => event.latitude,
                            lng: () => event.longitude,
                        }
                    }
                };
            } else {
                document.querySelector('#link-evento-online').value = event.link;
            }

            document.querySelector('#start-date').value = event.startDate;
            document.querySelector('#start-time').value = event.startTime;
            document.querySelector('#final-date').value = event.finalDate;
            document.querySelector('#final-time').value = event.finalTime;
            document.querySelector('#informacoes').value = event.informacoes;
            document.querySelector('#uploadedimage').src = event.bannerURL;
            bannerUrl = event.bannerURL;

            var isChrome = /Chrome/.test(navigator.userAgent);
            var isFirefox = /Firefox/.test(navigator.userAgent);

            if (isChrome) {
                document.querySelector('#sobre').value = event.sobre;
            } else if (isFirefox) {
                tinymce.get('sobre').setContent(event.sobre);
            }
        }


        async function updateEvent(event, startDatePicker, finalDatePicker) {
            const termsCheckbox = document.getElementById('terms-checkbox');

            if (!termsCheckbox.checked) {
                alert('Você precisa aceitar os termos de uso antes de atualizar o evento.');
                return;
            }

            const nomeEvento = document.querySelector('#nome');
            const categorias = document.querySelector('#categorias');
            const tipoEvento = document.querySelector('input[name="event-type"]:checked');
            const startDateEvento = document.querySelector('#start-date');
            const startTimeEvento = document.querySelector('#start-time');
            const sobreEvento = document.querySelector('#sobre');
            const informacoesEvento = document.querySelector('#informacoes');
            const sobre = tinymce.get('sobre').getContent();

            if (!nomeEvento.value) {
                alert('O campo nome é obrigatório.');
                nomeEvento.focus();
                return;
            }
            if (!categorias.value) {
                alert('O campo categorias é obrigatório.');
                categorias.focus();
                return;
            }
            if (!tipoEvento) {
                alert('Selecione o tipo de evento (presencial ou online).');
                return;
            }
            if (!startDateEvento.value) {
                alert('O campo data de início do evento é obrigatório.');
                startDateEvento.focus();
                return;
            }
            if (!startTimeEvento.value) {
                alert('O campo horário de início do evento é obrigatório.');
                startTimeEvento.focus();
                return;
            }
            if (!sobre.trim()) {
                alert('O campo sobre o evento é obrigatório.');
                return;
            }
            if (!informacoesEvento.value) {
                alert('O campo informações adicionais é obrigatório.');
                informacoesEvento.focus();
                return;
            }

            const tipoEventoValue = tipoEvento.value;

            if (tipoEventoValue === 'presencial') {
                if (!selectedPlace || !selectedPlace.formatted_address) {
                    alert('O campo local é obrigatório para eventos presenciais.');
                    document.getElementById('local').focus();
                    return;
                }
            }

            if (tipoEventoValue === 'online') {
                const linkEventoOnline = document.querySelector('#link-evento-online');
                if (!linkEventoOnline.value) {
                    alert('O campo link do evento é obrigatório para eventos online.');
                    linkEventoOnline.focus();
                    return;
                }
            }

            try {
                const urlParams = new URLSearchParams(window.location.search);
                const eventId = urlParams.get('edit');

                if (!bannerUrl) {
                    alert('É obrigatório fazer o upload de uma imagem para o banner do evento.');
                    return;
                }

                const produtorId = localStorage.getItem('userData');

                if (!produtorId) {
                    alert('Erro ao obter o ID do produtor. Faça login novamente.');
                    return;
                }

                const categoriaValue = categorias.value;
                const link = tipoEvento.value === 'online' ? document.querySelector('#link-evento-online').value : '';
                const finalDateEvento = document.querySelector('#final-date').value;
                const finalTimeEvento = document.querySelector('#final-time').value;

                const evento = {
                    tipo: tipoEvento.value,
                    produtorId: produtorId,
                    categoria: categoriaValue,
                    nome: nomeEvento.value,
                    link: link,
                    local: selectedPlace ? selectedPlace.formatted_address : '',
                    latitude: selectedPlace ? selectedPlace.geometry.location.lat() : null,
                    longitude: selectedPlace ? selectedPlace.geometry.location.lng() : null,
                    startDate: startDateEvento.value,
                    startTime: startTimeEvento.value,
                    finalDate: finalDateEvento,
                    finalTime: finalTimeEvento,
                    sobre: sobre,
                    informacoes: informacoesEvento.value,
                    bannerURL: bannerUrl
                };

                const updateResponse = await fetch(obterUrlBase()+`/eventos/${eventId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(evento),
                });

                if (!updateResponse.ok) {
                    throw new Error('Erro ao atualizar evento');
                }

                window.location.replace('meus-eventos.html');

                const responseData = await updateResponse.json();

                console.log('Evento atualizado:', responseData);
                alert('Evento atualizado com sucesso!');

            } catch (error) {
                console.error('Erro ao atualizar evento:', error);
                alert('Erro ao atualizar evento. Tente novamente mais tarde.');
            }
        }

        //-------------------------------------------------------------------------------------------------//





    </script>
</body>

</html>