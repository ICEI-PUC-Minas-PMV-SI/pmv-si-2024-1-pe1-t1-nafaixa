<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus eventos</title>

    <link rel="stylesheet" href="CSS/reset.css" />
    <link rel="stylesheet" href="CSS/components/navbar.css" />
    <link rel="stylesheet" href="CSS/components/navbar-mobile.css">
    <link rel="stylesheet" href="CSS/components/popup.css">
    <link rel="stylesheet" href="CSS/components/page-style.css" />
    <link rel="stylesheet" href="CSS/components/title.css" />
    <link rel="stylesheet" href="CSS/components/footer.css" />
    <link rel="stylesheet" href="CSS/components/meus-eventos.css">
    <link rel="shortcut icon" href="assets/img/logo.xs.svg" type="image/x-icon" />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="./JS/obterUrlBase.js"></script>


</head>

<body>
    <header>
        <div class="navcenter" id="navbar-logged-out">
            <div>
                <a href="index.html">
                    <img class="logo" src="assets/img/logo2.svg" alt="logo do NaFaixa" />
                </a>
            </div>
            <nav class="nav-options-web">
                <div onclick="openPopup()" class="localização-web">
                    <img src="assets/img/localpin.svg" </img>
                    <span class="localização-web" id="escolherLocalização">Localização</span>
                    <img src="assets/img/setaprabaixo1.svg" style="padding-right: 15px"></img>
                </div>

                <a onclick='return handleCriarEventoOnClick()' href="criar-evento.html">Criar evento</a>
                <a id="entrar-btn" class="joinBtn" href="login.html">Entrar</a>
            </nav>

        </div>

        <div class="navcenter-mobile" id="navbar-logged-in" style="display: none">
            <div>
                <a href="index.html">
                    <img class="logo" src="assets/img/logo2.svg" alt="logo do NaFaixa" />
                </a>
            </div>
            <nav class="nav-options-web">
                <div class="nav-options-logged-in">
                    <div onclick="openPopup()" class="localização-web">
                        <img src="assets/img/localpin.svg" </img>
                        <span class="localização-web" id="escolherLocalizaçãoLoggedin">Localização</span>
                        <img src="assets/img/setaprabaixo1.svg" style="padding-right: 15px"></img>
                    </div>
                    <a id="hide-criar-evento-mobile" href="criar-evento.html">Criar evento</a>

                    <nav class="menu-hamburguer">
                        <input type="checkbox" class="checkbox-menu">

                        <img id="logo-produtor-menu" src="https://source.unsplash.com/random/1" alt="foto perfil">

                        <div id="menu-options2">
                            <ul>
                                <a id="meu-perfil" href="cadastro-produtor.html" onclick="redirecionarParaEdicao()">Meu
                                    Perfil</a></br>
                                <a href="meus-eventos.html">Meus eventos</a></br>
                                <a href="criar-evento.html">Criar evento</a>
                                <a id="botaoSair" href="#">Sair</a>
                            </ul>
                        </div>
                    </nav>
                </div>
            </nav>
        </div>
        </div>

        <div class="navcenter-mobile" id="navbar-logged-out-mobile">
            <div>
                <a href="index.html">
                    <img class="logo" src="assets/img/logo2.svg" alt="logo do NaFaixa" /></a>
            </div>
            <div onclick="openPopup()" class="localizacao-mobile">
                <img src="assets/img/localpin.svg" </img>
                <span class="localizacao-mobile" id="escolherLocalizacaoMobile">Localização</span>
            </div>
            <nav class="menu-hamburguer">
                <input type="checkbox" class="checkbox-menu">

                <label for="checkbox-menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </label>

                <div id="menu-options">
                    <ul>
                        <a href="login.html">Entrar</a></br>
                        <a onclick='return handleCriarEventoOnClick()' href="criar-evento.html">Criar evento</a>
                    </ul>
                </div>
            </nav>
        </div>
        </nav>
        </div>
    </header>

    <form action="todos-eventos.html" method="GET" id="search-form" class="nav-search-mobile">
        <div class="search">
            <span class="search-icon material-symbols-outlined">search</span>
            <input type="text" class="search-input" name="q" placeholder="Pesquise por evento...">
        </div>
    </form>

    <div class="popup" id="locationPopup">
        <div class="popup-content">
            <h5>Escolha uma localização</h5>
            <input type="text" id="cityInput" placeholder="Digite o nome da cidade que deseja...">
        </div>
    </div>


    <section class="page">
        <div style="width: 100%">
            <h1>Meus eventos</h1>

            <div id="meus-eventos-container" class="cards-meus-eventos-container"></div>
    </section>

    </div>
    <footer>
        <div class="footercenter">
            <div class="subtitulo">
                <p>O seu site de eventos gratuitos</p>

                <img class="logofooter" src="assets/img/logo2.svg" alt="logo NaFaixa" />
            </div>

            <div class="txtfooter">
                <a href="sobrenos.html">Sobre nós</a>
                <a href="termosdeuso.html">Termos de uso</a>
            </div>
        </div>
    </footer>
    <script src="./JS/navbarUpdate.js"></script>
    <script src="./JS/meusEventos.js"></script>
    <script src="JS/logout.js"></script>
    <script src="JS/barra-pesquisa.js"></script>

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script
        src="https://maps.googleapis.com/maps/api/js?key=CHAVE_GOOGLE_MAPS&libraries=places"></script>
    <script>

        function handleCriarEventoOnClick(e) {
            if (!isUserLoggedIn()) {
                window.location.href = 'login.html';
                return false;
            };
        };

        function isUserLoggedIn() {
            return localStorage.getItem('userData');
        };

        // Função para obter a geolocalização do usuário
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;

                        const geocoder = new google.maps.Geocoder();
                        const latlng = { lat: latitude, lng: longitude };

                        geocoder.geocode({ location: latlng }, (results, status) => {
                            if (status === "OK") {
                                if (results[0]) {
                                    const cityName = results[0].address_components[3].long_name;

                                    localStorage.setItem('userLocation', JSON.stringify({
                                        latitude: latitude,
                                        longitude: longitude,
                                        city: cityName
                                    }));

                                    updateNavbarLocation(cityName);
                                }
                            }
                        });
                    },
                    (error) => {
                        console.error('Erro ao obter localização:', error);
                    }
                );
            } else {
                console.error('Geolocalização não suportada pelo navegador.');
            }
        }

        // Função para abrir o popup/fechar o popup
        const popup = document.getElementById('locationPopup');

        function openPopup() {
            popup.style.display = 'block';

            window.addEventListener('click', closePopupOutside);

            window.addEventListener('keydown', closePopupOnEsc);

            function closePopupOutside(event) {
                if (event.target === popup) {
                    popup.style.display = 'none';
                    window.removeEventListener('click', closePopupOutside);
                    window.removeEventListener('keydown', closePopupOnEsc);
                }
            }

            function closePopupOnEsc(event) {
                if (event.key === 'Escape') {
                    popup.style.display = 'none';
                    window.removeEventListener('click', closePopupOutside);
                    window.removeEventListener('keydown', closePopupOnEsc);
                }
            }

            //Função de autocomplete do google no input do popup
            var input = document.getElementById('cityInput');
            var autocomplete = new google.maps.places.Autocomplete(input, {
                types: ['(cities)'],
                componentRestrictions: { country: 'BR' }
            });

            autocomplete.addListener('place_changed', function () {
                var selectedPlace = autocomplete.getPlace();
                if (!selectedPlace.geometry) {
                    return;
                }

                var cityName = selectedPlace.name;

                updateNavbarLocation(cityName);

                localStorage.setItem('userLocation', JSON.stringify({
                    cityName: cityName,
                    latitude: selectedPlace.geometry.location.lat(),
                    longitude: selectedPlace.geometry.location.lng()
                }));
                window.location.href = window.location.href;

                document.getElementById('locationPopup').style.display = 'none';
            });
        }

        // Função para atualizar a localização na navbar
        function updateNavbarLocation(cityName) {
            var locationElementWeb = document.getElementById('escolherLocalização');
            var locationElementMobile = document.getElementById('escolherLocalizacaoMobile');
            var locationElementLoggedIn = document.getElementById('escolherLocalizaçãoLoggedin');
            if (locationElementWeb) {
                locationElementWeb.textContent = cityName;
            }
            if (locationElementMobile) {
                locationElementMobile.textContent = cityName;
            }
            if (locationElementLoggedIn) {
                locationElementLoggedIn.textContent = cityName;
            }
        }

        window.onload = function () {
            var userLocation = localStorage.getItem('userLocation');
            if (userLocation) {
                userLocation = JSON.parse(userLocation);
                if (userLocation.cityName) {
                    updateNavbarLocation(userLocation.cityName);
                }
            }
        };

        // Função para atualizar o nome da cidade na navbar
        function updateNavbarLocation(cityName) {
            var locationElementWeb = document.getElementById('escolherLocalização');
            var locationElementMobile = document.getElementById('escolherLocalizacaoMobile');
            var locationElementLoggedIn = document.getElementById('escolherLocalizaçãoLoggedin');
            if (locationElementWeb) {
                locationElementWeb.textContent = cityName;
            }
            if (locationElementMobile) {
                locationElementMobile.textContent = cityName;
            }
            if (locationElementLoggedIn) {
                locationElementLoggedIn.textContent = cityName;
            }
        }

        window.onload = () => {
            const userLocation = JSON.parse(localStorage.getItem('userLocation'));
            if (!userLocation) {
                getLocation();
            } else {
                updateNavbarLocation(userLocation.city);
            }
        };

        // Função para carregar e definir a localização ao recarregar a página
        function loadUserLocation() {
            var userLocation = localStorage.getItem('userLocation');
            if (userLocation) {
                userLocation = JSON.parse(userLocation);
                if (userLocation.cityName) {
                    updateNavbarLocation(userLocation.cityName);
                }
            }
        }

        window.addEventListener('load', function () {
            loadUserLocation();
        });

    </script>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=CHAVE_GOOGLE_MAPS&libraries=places&language=pt-BR"></script>
    </script>

</body>

</html>