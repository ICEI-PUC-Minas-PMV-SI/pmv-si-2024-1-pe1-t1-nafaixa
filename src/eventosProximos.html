<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NaFaixa</title>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
  <script src="https://use.fontawesome.com/releases/v6.2.0/js/all.js"></script>
  <link rel="stylesheet" type="text/css" href="./CSS/components/mapa.css" />
  <script src="./JS/mapa.js"></script>

  <link rel="shortcut icon" href="assets/img/logo.xs.svg" type="image/x-icon" />

  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="CSS/reset.css" />
  <link rel="stylesheet" href="CSS/components/navbar.css" />
  <link rel="stylesheet" href="CSS/components/popup.css" />
  <link rel="stylesheet" href="CSS/components/navbar-mobile.css">
  <link rel="stylesheet" href="CSS/components/">
  <link rel="stylesheet" href="CSS/components/page-style.css" />
  <link rel="stylesheet" href="CSS/components/title.css" />
  <link rel="stylesheet" href="CSS/components/event-cards.css" />
  <link rel="stylesheet" href="CSS/components/main-carousel.css" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="CSS/components/categorias-cards.css" />
  <link rel="stylesheet" href="CSS/components/footer.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>




  <script>
    var eventos = []
    async function carregarTodosEventos() {
      console.log('carregando eventos')

      try {
        const response = await fetch("http://localhost:3000/eventos");
        eventos = await response.json();
        initMap(eventos)
        console.log('eventos buscados')
      } catch (error) {
        console.error("Erro ao carregar os eventos:", error);
      }
    }
    carregarTodosEventos()

    function openPopup() {
      console.log('abrindo popup')
      const popup = document.getElementById('locationPopup');
      popup.style.display = 'block';

      window.addEventListener('click', closePopupOutside);

      window.addEventListener('keydown', closePopupOnEsc);

      function closePopupOutside(event) {
        if (event.target === popup) {
          popup.style.display = 'none';
          window.removeEventListener('click', closePopupOutside);
          window.removeEventListener('keydown', closePopupOnEsc);
        }
      }

      function closePopupOnEsc(event) {
        if (event.key === 'Escape') {
          popup.style.display = 'none';
          window.removeEventListener('click', closePopupOutside);
          window.removeEventListener('keydown', closePopupOnEsc);
        }
      }

      //Função de autocomplete do google no input do popup
      var input = document.getElementById('cityInput');
      var autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['(cities)'],
        componentRestrictions: { country: 'BR' }
      });

      autocomplete.addListener('place_changed', function () {
        var selectedPlace = autocomplete.getPlace();
        if (!selectedPlace.geometry) {
          return;
        }

        var cityName = selectedPlace.name;

        updateNavbarLocation(cityName);
        const latitude = selectedPlace.geometry.location.lat()
        const longitude = selectedPlace.geometry.location.lng()
        localStorage.setItem('userLocation', JSON.stringify({
          cityName: cityName,
          latitude,
          longitude
        }));

        document.getElementById('locationPopup').style.display = 'none';
        initMap(eventos, { latitude, longitude })
        //sobrescreve user location do mapa
        localStorage.setItem(
          "mapUserLocation",
          JSON.stringify({ latitude, longitude })
        );
        //bloqueia mapa de atualizar localização após refresh
        localStorage.setItem(
          "isMapLocationBlocked",
          JSON.stringify(true)
        );
        location.reload()

      });
    }

    // Função para atualizar a localização na navbar
    function updateNavbarLocation(cityName) {
      var locationElementWeb = document.getElementById('escolherLocalização');
      var locationElementMobile = document.getElementById('escolherLocalizacaoMobile');
      if (locationElementWeb) {
        locationElementWeb.textContent = cityName;
      }
      if (locationElementMobile) {
        locationElementMobile.textContent = cityName;
      }
    }

    window.onload = function () {
      var userLocation = localStorage.getItem('userLocation');
      if (userLocation) {
        userLocation = JSON.parse(userLocation);
        if (userLocation.cityName) {
          updateNavbarLocation(userLocation.cityName);
        }
      }
    };

    // Função para atualizar o nome da cidade na navbar
    function updateNavbarLocation(cityName) {
      var locationElementWeb = document.getElementById('escolherLocalização');
      var locationElementMobile = document.getElementById('escolherLocalizacaoMobile');
      if (locationElementWeb) {
        locationElementWeb.textContent = cityName;
      }
      if (locationElementMobile) {
        locationElementMobile.textContent = cityName;
      }
    }

    window.onload = () => {
      const userLocation = JSON.parse(localStorage.getItem('userLocation'));
      if (!userLocation) {
        getLocation();
      } else {
        updateNavbarLocation(userLocation.city);
      }
    };

    // Função para carregar e definir a localização ao recarregar a página
    function loadUserLocation() {
      var userLocation = localStorage.getItem('userLocation');
      if (userLocation) {
        userLocation = JSON.parse(userLocation);
        if (userLocation.cityName) {
          updateNavbarLocation(userLocation.cityName);
        }
      }
    }

    window.addEventListener('load', function () {
      loadUserLocation();
    });

    function voltarParaLocalizacaoAtual() {
      localStorage.removeItem("isMapLocationBlocked");
      localStorage.setItem("mapUserLocation", localStorage.getItem('currentMapUserLocation'));
      location.reload()
    }

  </script>
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC6Mt2GUjTup_ly3tWro_MnX6L9v_l5o1s&libraries=places&language=pt-BR"></script>
  </script>
  <script src="/src/JS//esconderMapa.js">
  </script>
  <script src="/src/JS/cardsEvento.js"></script>
</head>

<body>
  <div class="popup" id="locationPopup">
    <div class="popup-content">
      <h5>Escolha uma localização</h5>
      <input type="text" id="cityInput" placeholder="Digite o nome da cidade que deseja...">

      <button class="esconderMapa-button voltarLocalizacao" onclick="voltarParaLocalizacaoAtual()" id=""
        href="index.html"><span id="">Voltar para localização atual</span>
      </button>
    </div>
  </div>
  </div>

  <header>
    <div class="navcenter" id="navbar-logged-out">
      <div>
        <a href="index.html">
          <img class="logo" src="assets/img/logo2.svg" alt="logo do NaFaixa" /></a>
      </div>
      <form class="nav-search">
        <div class="search">
          <span class="search-icon material-symbols-outlined">search</span>
          <input class="search-input" type="search" placeholder="pesquise por evento" />
        </div>
      </form>
      <nav class="nav-options-web">
        <div onclick="openPopup()" class="localização-web">
          <img src="assets/img/localpin.svg">
          <span class="localização-web" id="escolherLocalização">Localização</span>
          <img src="assets/img/setaprabaixo1.svg" style="padding-right: 15px"></img>
        </div>

        <a onclick='return handleCriarEventoOnClick()' href="criar-evento.html">Criar evento</a>
        <a id="entrar-btn" class="joinBtn" href="login.html">Entrar</a>
      </nav>
    </div>


    <div id="navbar-logged-in" style="display: none">
      <div>
        <a href="index.html">
          <img class="logo" src="assets/img/logo2.svg" alt="logo do NaFaixa" />
        </a>
      </div>

      <a href="">Localização</a>

      <nav class="menu-hamburguer">
        <input type="checkbox" class="checkbox-menu">

        <img src="https://source.unsplash.com/random/1" alt="foto perfil">

        <div id="menu-options">
          <ul>
            <a id="meu-perfil" href="cadastro-produtor.html" onclick="redirecionarParaEdicao()">Meu
              Perfil</a>
            <a href="meus-eventos.html">Meus eventos</a></br>
            <a href="criar-evento.html">Criar evento</a>
            <a href="#">Sair</a>
          </ul>
        </div>
      </nav>
    </div>

    <div class="navcenter-mobile">
      <div>
        <a href="index.html">
          <img class="logo" src="assets/img/logo2.svg" alt="logo do NaFaixa" /></a>
      </div>

      <a href="">Localização</a>

      <nav class="menu-hamburguer">
        <input type="checkbox" class="checkbox-menu">

        <label for="checkbox-menu">
          <span></span>
          <span></span>
          <span></span>
        </label>

        <div id="menu-options">
          <ul>
            <a href="login.html">Entrar</a></br>
            <a href="criar-evento.html">Criar evento</a>
            <a href="#">Sair</a>
          </ul>
        </div>
      </nav>
    </div>
  </header>

  <form class="nav-search-mobile">
    <div class="search">
      <span class="search-icon material-symbols-outlined">search</span>
      <input class="search-input" type="search" placeholder="pesquise por evento" </input>
    </div>
  </form>

  <section class="page">
    <div style="width: 100%">
      <div class="events-nearme">
        <h1>Mapa de Eventos</h1>
        <button class="esconderMapa-button" id="esconderMapa-button" href="index.html"><span
            id="esconderMapaTexto">Esconder mapa</span>
          <svg class="IconeEsconderMapa" width="22" height="21" viewBox="0 0 22 21" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M10.672 1.75C8.81515 1.74991 7.03332 2.47779 5.71376 3.77544C4.3942 5.0731 3.64357 6.83564 3.625 8.68C3.625 13.475 9.83515 18.8125 10.0994 19.04C10.259 19.1756 10.462 19.2501 10.672 19.2501C10.8819 19.2501 11.085 19.1756 11.2445 19.04C11.5529 18.8125 17.719 13.475 17.719 8.68C17.7004 6.83564 16.9498 5.0731 15.6302 3.77544C14.3106 2.47779 12.5288 1.74991 10.672 1.75ZM10.672 17.1937C9.20092 15.8025 5.38674 11.9438 5.38674 8.68C5.38674 7.28761 5.94358 5.95226 6.93475 4.96769C7.92593 3.98312 9.27025 3.43 10.672 3.43C12.0737 3.43 13.418 3.98312 14.4092 4.96769C15.4004 5.95226 15.9572 7.28761 15.9572 8.68C15.9572 11.9175 12.143 15.8025 10.672 17.1937Z" />
            <path
              d="M10.6729 5.25C10.0631 5.25 9.46705 5.42961 8.96005 5.76612C8.45304 6.10264 8.05788 6.58093 7.82453 7.14053C7.59118 7.70013 7.53012 8.3159 7.64909 8.90996C7.76805 9.50403 8.06168 10.0497 8.49285 10.478C8.92402 10.9063 9.47337 11.198 10.0714 11.3162C10.6695 11.4343 11.2894 11.3737 11.8527 11.1419C12.4161 10.9101 12.8976 10.5176 13.2364 10.0139C13.5751 9.51031 13.756 8.91821 13.756 8.3125C13.756 7.50027 13.4311 6.72132 12.8529 6.14699C12.2748 5.57266 11.4906 5.25 10.6729 5.25ZM10.6729 9.625C10.4116 9.625 10.1561 9.54802 9.93882 9.4038C9.72153 9.25958 9.55218 9.0546 9.45217 8.81477C9.35216 8.57494 9.326 8.31104 9.37698 8.05644C9.42796 7.80184 9.5538 7.56798 9.73859 7.38442C9.92338 7.20087 10.1588 7.07586 10.4151 7.02522C10.6714 6.97458 10.9371 7.00057 11.1785 7.09991C11.42 7.19925 11.6263 7.36748 11.7715 7.58331C11.9167 7.79915 11.9942 8.05291 11.9942 8.3125C11.9942 8.6606 11.855 8.99444 11.6072 9.24058C11.3594 9.48672 11.0233 9.625 10.6729 9.625Z" />
          </svg>
        </button>
      </div>
      <div id="map"></div>
      <script>
        ((g) => {
          var h,
            a,
            k,
            p = "The Google Maps JavaScript API",
            c = "google",
            l = "importLibrary",
            q = "__ib__",
            m = document,
            b = window;
          b = b[c] || (b[c] = {});
          var d = b.maps || (b.maps = {}),
            r = new Set(),
            e = new URLSearchParams(),
            u = () =>
              h ||
              (h = new Promise(async (f, n) => {
                await (a = m.createElement("script"));
                e.set("libraries", [...r] + "");
                for (k in g)
                  e.set(
                    k.replace(/[A-Z]/g, (t) => "_" + t[0].toLowerCase()),
                    g[k]
                  );
                e.set("callback", c + ".maps." + q);
                a.src = `https://maps.${c}apis.com/maps/api/js?` + e;
                d[q] = f;
                a.onerror = () => (h = n(Error(p + " could not load.")));
                a.nonce = m.querySelector("script[nonce]")?.nonce || "";
                m.head.append(a);
              }));
          d[l]
            ? console.warn(p + " only loads once. Ignoring:", g)
            : (d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n)));
        })({ key: "AIzaSyBrUmshDSudmRUIkgFEGrHmR7rwQvItwqo", v: "weekly" });
      </script>

      <h1>Todos os eventos próximos de você!</h1>
      <div id="eventosFiltrados" class="wrapper-cards"></div>
      <div class="wrapper-mostrarMais">
        <button class="mostrarMais">mostrar mais</button>
      </div>
    </div>
  </section>
  <footer>
    <div class="footercenter">
      <div class="subtitulo">
        <p>O seu site de eventos gratuitos</p>

        <img class="logofooter" src="assets/img/logo2.svg" alt="logo NaFaixa" />
      </div>

      <div class="txtfooter">
        <a href="sobrenos.html">Sobre nós</a>
        <a href="termosdeuso.html">Termos de uso</a>
      </div>
    </div>
  </footer>
  <script src="./JS/meusEventos.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const meuPerfilLink = document.getElementById('meu-perfil');
      meuPerfilLink.addEventListener('click', function (event) {
        event.preventDefault();
        window.location.href = 'cadastro-produtor.html?edit';
      });
    });
  </script>
  <script src="./JS/navbarUpdate.js"></script>
  <script src="JS/logout.js"></script>
</body>

</html>