<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro-Produtor</title>

  <link rel="shortcut icon" href="assets/img/logo.xs.svg" type="image/x-icon" />
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="CSS/reset.css" />
  <link rel="stylesheet" href="CSS/components/navbar.css" />
  <link rel="stylesheet" href="CSS/components/navbar-mobile.css" />
  <link rel="stylesheet" href="CSS/components/page-style.css" />
  <link rel="stylesheet" href="CSS/components/title.css" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="CSS/components/footer.css" />
  <link rel="stylesheet" href="CSS/components/cadastro-produtor.css" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/cloudinary-core/2.11.4/cloudinary-core-shrinkwrap.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
</head>

<body>
  <header>
    <div class="navcenter" id="navbar-logged-out">
      <div>
        <a href="index.html">
          <img class="logo" src="assets/img/logo2.svg" alt="logo do NaFaixa" /></a>
      </div>
      <form class="nav-search">
        <div class="search">
          <span class="search-icon material-symbols-outlined">search</span>
          <input class="search-input" type="search" placeholder="pesquise por evento" />
        </div>
      </form>
      <nav class="nav-options-web">
        <a href="">Localização</a>
        <a href="">Criar evento</a>
        <a id="entrar-btn" class="joinBtn" href="login.html">Entrar</a>
      </nav>
    </div>

    <div class="navcenter-mobile" id="navbar-logged-in" style="display: none">
      <div>
        <a href="index.html">
          <img class="logo" src="assets/img/logo2.svg" alt="logo do NaFaixa" />
        </a>
      </div>

      <a href="">Localização</a>

      <nav class="menu-hamburguer">
        <input type="checkbox" class="checkbox-menu">

        <img src="https://source.unsplash.com/random/1" alt="foto perfil">

        <div id="menu-options">
          <ul>
            <a id="meu-perfil" href="cadastro-produtor.html" onclick="redirecionarParaEdicao()">Meu
              Perfil</a>
            <a href="meus-eventos.html">Meus eventos</a></br>
            <a href="criar-evento.html">Criar evento</a>
            <a href="#">Sair</a>
          </ul>
        </div>
      </nav>
    </div>

    <div class="navcenter-mobile" id="navbar-logged-out-mobile">
      <div>
        <a href="index.html">
          <img class="logo" src="assets/img/logo2.svg" alt="logo do NaFaixa" /></a>
      </div>

      <a href="">Localização</a>

      <nav class="menu-hamburguer">
        <input type="checkbox" class="checkbox-menu" />

        <label for="checkbox-menu">
          <span></span>
          <span></span>
          <span></span>
        </label>

        <div id="menu-options">
          <ul>
            <a href="login.html">Entrar</a>
            <a href="criar-evento.html">Criar evento</a>
            <a href="#">Sair</a>
          </ul>
        </div>
      </nav>
    </div>
  </header>

  <section class="page">
    <div style="width: 100%">
      <h1>Informações pessoais</h1>
      <form action="" class="form-produtor">
        <div class="form-item">
          <label for="nome-produtor">Nome completo</label>
          <input type="text" id="produtor-nome" name="nome-produtor" required />
        </div>

        <div class="form-item">
          <label for="identificacao-produtor">CPF / CNPJ</label>
          <input type="text" id="produtor-identificacao" name="identificacao-produtor" required />
        </div>

        <div class="form-item">
          <label for="celular-produtor">Celular</label>
          <input type="text" id="produtor-celular" name="celular-produtor" required />
        </div>

        <div class="form-item-localizacao">
          <div class="localizacao-produtor">
            <label for="cidade-produtor">Cidade</label>
            <input type="text" id="produtor-cidade" name="cidade-produtor" required />
          </div>

          <div class="localizacao-produtor">
            <label for="estado-produtor">Estado</label>
            <input type="text" id="produtor-estado" name="estado-produtor" required />
          </div>
        </div>
        <div class="form-item">
          <label for="email-produtor">E-mail</label>
          <input type="text" id="produtor-email" name="email-produtor" required />
        </div>

        <div class="form-item" id="senha-container">
          <label for="password">Digite sua senha</label>
          <input type="password" id="criar-senha" class="new-password" name="new-password" required />
        </div>

        <div class="form-item" id="repita-senha-container">
          <label for="password">Repita sua senha</label>
          <input type="password" id="repita-senha" class="new-password" name="new-password" required />
        </div>
      </form>

      <h2>Sobre o produtor</h2>
      <form action="" class="adicional-produtor">
        <label for="adicional-produtor">Fale sobre você - a quanto tempo está no mercado, que tipo de
          evento produz, etc.
        </label>
        <textarea name="adicional-produtor" id="produtor-sobre" type="text" cols="100" rows="10"></textarea>
      </form>

      <h2>Contato público</h2>
      <p id="paragrafo">
        Informe um meio de contato para que o público possa entrar em contato
        com você.
      </p>
      <form action="" class="contato-produtor">
        <label for="email-publico">E-mail</label>
        <input type="text" name="email-publico" id="email-publico" />

        <label for="celular-publico">Celular</label>
        <input type="text" name="celular-publico" id="celular-publico" />
      </form>

      <div class="perfil">
        <label for="foto-perfil">Faça upload da logo da sua produtora</label>
        <input type="file" name="file" accept="image/*" id="foto-produtor" />
        <img id="foto-produtor-preview" class="preview-foto-produtor" height="auto" src="#" alt="Foto do produtor" />
      </div>

      <div class="termos-uso">
        <input type="checkbox" id="aceito-termos" />
        <label>Li e aceito os
          <a href="termosdeuso.html" target="_blank">termos de uso.</a></label>
      </div>
    </div>
  </section>

  <div class="button">
    <a class="button-criar">Criar perfil</a>
  </div>

  <footer>
    <div class="footercenter">
      <div class="subtitulo">
        <p>O seu site de eventos gratuitos</p>
        <img class="logofooter" src="assets/img/logo2.svg" alt="logo NaFaixa" />
      </div>

      <div class="txtfooter">
        <a href="sobrenos.html">Sobre nós</a>
        <a href="termosdeuso.html">Termos de uso</a>
      </div>
    </div>
  </footer>

  <script>
    // Preview da foto do produtor
    const eventBannerInput = document.querySelector("#foto-produtor");
    const eventBannerPreview = document.querySelector("#foto-produtor-preview");

    eventBannerInput.onchange = (evt) => {
      const [file] = eventBannerInput.files;
      if (file) {
        eventBannerPreview.src = URL.createObjectURL(file);
      }
      eventBannerPreview.style.display = "block";
    };

    function hashPassword(password) {
      return CryptoJS.MD5(password).toString();
    }

    async function criarProdutor() {
      const url = "http://localhost:3000/produtor";

      const nomeProdutor = document.querySelector("#produtor-nome");
      const identificacaoProdutor = document.querySelector("#produtor-identificacao");
      const celularProdutor = document.querySelector("#produtor-celular");
      const cidadeProdutor = document.querySelector("#produtor-cidade");
      const estadoProdutor = document.querySelector("#produtor-estado");
      const emailProdutor = document.querySelector("#produtor-email");
      const sobreProdutor = document.querySelector("#produtor-sobre");
      const emailPublico = document.querySelector("#email-publico");
      const celularPublico = document.querySelector("#celular-publico");
      const aceitoTermos = document.querySelector("#aceito-termos");
      const senha = document.querySelector("#criar-senha");
      const senhaHash = hashPassword(senha.value);

      const fotoProdutorInput = document.querySelector("#foto-produtor");
      const fotoProdutorFile = fotoProdutorInput.files[0];

      // Cloudinary config
      const cloudName = "dmcuzezlv";
      const unsignedUploadPreset = "w1cukmci";

      const formData = new FormData();
      formData.append("file", fotoProdutorFile);
      formData.append("upload_preset", unsignedUploadPreset);

      try {
        const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
          method: "POST",
          body: formData,
        });

        if (!response.ok) {
          throw new Error(`Erro ao fazer upload da imagem para o Cloudinary. Status: ${response.status}`);
        }

        const data = await response.json();
        const fotoProdutorURL = data.secure_url;

        const payload = {
          id: uuid.v4(),
          nome: nomeProdutor.value,
          cpf: identificacaoProdutor.value,
          celular: celularProdutor.value,
          cidade: cidadeProdutor.value,
          estado: estadoProdutor.value,
          email: emailProdutor.value,
          senha: senhaHash,
          logo: fotoProdutorURL,
          descricao: sobreProdutor.value,
          email_publico: emailPublico.value,
          celular_publico: celularPublico.value,
        };

        const responseCadastro = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });

        if (!responseCadastro.ok) {
          throw new Error(`Erro ao cadastrar o produtor. Status: ${responseCadastro.status}`);
        }

        const dataCadastro = await responseCadastro.json();
        console.log(dataCadastro);
        alert("Seu cadastro foi realizado com sucesso.");
      } catch (error) {
        console.error("Erro:", error);
        alert("Erro em concluir o cadastro. Por favor tente mais tarde.");
      }
      window.location.href = "login.html";
    }

    function verificarCampos() {
      const primeiraSenha = document.querySelector("#criar-senha").value;
      const segundaSenha = document.querySelector("#repita-senha").value;

      if (isEditMode()) {
        return true;
      }

      if (primeiraSenha !== segundaSenha) {
        alert("As senhas não coincidem. Por favor, digite novamente.");
        return false;
      }

      const camposObrigatorios = document.querySelectorAll(".form-produtor input[required]");
      for (let campo of camposObrigatorios) {
        if (!campo.value) {
          alert(`O campo ${campo.name} é obrigatório.`);
          campo.focus();
          return false;
        }
      }
      if (!document.querySelector("#aceito-termos").checked) {
        alert("Você deve aceitar os termos de uso para se cadastrar.");
        return false;
      }

      criarProdutor();
    }

    async function verificarDuplicatas(cpf, email) {
      if (isEditMode()) {
        return true;
      }
      try {
        const response = await fetch("http://localhost:3000/produtor");
        const dataDuplicata = await response.json();

        for (let produtor of dataDuplicata) {
          if (produtor.cpf == cpf) {
            alert("CPF já cadastrado. Por favor, insira um CPF diferente.");
            return false;
          }
          if (produtor.email == email) {
            alert("E-mail já cadastrado. Por favor, insira um e-mail diferente.");
            return false;
          }
        }

        return true;
      } catch (error) {
        console.error("Erro ao verificar duplicatas:", error);
        return false;
      }
    }

    document.querySelector(".button-criar").addEventListener("click", async function () {
      const cpf = document.querySelector("#produtor-identificacao").value;
      const email = document.querySelector("#produtor-email").value;

      const duplicatas = await verificarDuplicatas(cpf, email);

      if (duplicatas) {
        verificarCampos();
      }
    });

    // Edição do cadastro do produtor
    function isEditMode() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.has('edit');
    }

    async function preencherDadosProdutor() {
      try {
        const response = await fetch(`http://localhost:3000/produtor/${localStorage.getItem('userData')}`);
        const produtor = await response.json();

        document.querySelector("#produtor-nome").value = produtor.nome;
        document.querySelector("#produtor-identificacao").value = produtor.cpf;
        document.querySelector("#produtor-celular").value = produtor.celular;
        document.querySelector("#produtor-cidade").value = produtor.cidade;
        document.querySelector("#produtor-estado").value = produtor.estado;
        document.querySelector("#produtor-email").value = produtor.email;
        document.querySelector("#produtor-sobre").value = produtor.descricao;
        document.querySelector("#email-publico").value = produtor.email_publico;
        document.querySelector("#celular-publico").value = produtor.celular_publico;
        document.querySelector("#foto-produtor-preview").src = produtor.logo;
        document.querySelector("#foto-produtor-preview").style.display = "block";

      } catch (error) {
        console.error("Erro ao preencher dados do produtor:", error);
        alert("Erro ao preencher dados do produtor. Por favor, tente novamente mais tarde.");
      }
    }

    async function salvarAlteracoes() {
      const url = `http://localhost:3000/produtor/${localStorage.getItem('userData')}`;
      const senha = document.querySelector("#criar-senha").value;
      let senhaHash = null;

      if (senha) {
        senhaHash = hashPassword(senha);
      }

      const nomeProdutor = document.querySelector("#produtor-nome").value;
      const identificacaoProdutor = document.querySelector("#produtor-identificacao").value;
      const celularProdutor = document.querySelector("#produtor-celular").value;
      const cidadeProdutor = document.querySelector("#produtor-cidade").value;
      const estadoProdutor = document.querySelector("#produtor-estado").value;
      const emailProdutor = document.querySelector("#produtor-email").value;
      const sobreProdutor = document.querySelector("#produtor-sobre").value;
      const emailPublico = document.querySelector("#email-publico").value;
      const celularPublico = document.querySelector("#celular-publico").value;

      const fotoProdutorInput = document.querySelector("#foto-produtor");
      const fotoProdutorFile = fotoProdutorInput.files[0];

      const cloudName = "dmcuzezlv";
      const unsignedUploadPreset = "w1cukmci";

      let produtorAtual;
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Erro ao obter os dados atuais do produtor. Status: ${response.status}`);
        }
        produtorAtual = await response.json();
      } catch (error) {
        console.error("Erro ao obter os dados atuais do produtor:", error);
        alert("Erro ao obter os dados atuais do produtor. Por favor, tente novamente mais tarde.");
        return;
      }

      const payload = {
        nome: nomeProdutor,
        cpf: identificacaoProdutor,
        celular: celularProdutor,
        cidade: cidadeProdutor,
        estado: estadoProdutor,
        email: emailProdutor,
        descricao: sobreProdutor,
        email_publico: emailPublico,
        celular_publico: celularPublico,
        logo: produtorAtual.logo,
      };

      if (senhaHash) {
        payload.senha = senhaHash;
      }

      if (fotoProdutorFile) {
        const formData = new FormData();
        formData.append("file", fotoProdutorFile);
        formData.append("upload_preset", unsignedUploadPreset);

        try {
          const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            throw new Error(`Erro ao fazer upload da imagem para o Cloudinary. Status: ${response.status}`);
          }

          const data = await response.json();
          payload.logo = data.secure_url;
        } catch (error) {
          console.error("Erro ao fazer upload da imagem:", error);
          alert("Erro ao fazer upload da imagem. Por favor, tente novamente mais tarde.");
          return;
        }
      }

      try {
        const response = await fetch(url, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`Erro ao atualizar os dados do produtor. Status: ${response.status}`);
        }

        alert("Dados atualizados com sucesso!");
      } catch (error) {
        console.error("Erro ao salvar alterações:", error);
        alert("Erro ao salvar alterações. Por favor, tente novamente mais tarde.");
      }
    }


    document.addEventListener("DOMContentLoaded", async function () {
      if (isEditMode()) {
        await preencherDadosProdutor();
        const buttonCriar = document.querySelector(".button-criar");
        buttonCriar.textContent = "Salvar Alterações";
        buttonCriar.removeEventListener("click", verificarCampos);
        buttonCriar.addEventListener("click", salvarAlteracoes);

        const senhaContainer = document.getElementById("senha-container");
        senhaContainer.style.display = "none";
        const repitaSenhaContainer = document.getElementById("repita-senha-container");
        repitaSenhaContainer.style.display = "none";

        const aceitarTermosUso = document.querySelector('.termos-uso');
        aceitarTermosUso.style.display = "none";
      }
    });

  </script>
  <script src="./JS/meusEventos.js"></script>

  <script src="./JS/navbarUpdate.js"></script>

</body>

</html>